<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Encriptar Texto</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>Encriptar Texto</h1>

    <textarea id="plain" placeholder="Escribe el texto a cifrar"></textarea><br>
    <button onclick="encryptAndSave()">Cifrar y Guardar</button>

    <h2>Historial</h2>
    <div id="list"></div>
    <button onclick="clearHistory()">Borrar Historial</button>

    <p><a href="decrypt.html">Ir a Desencriptar</a></p>
    <button onclick="logout()">Cerrar Sesión</button>
</div>

<script src="js/auth.js"></script>

<script>
// Verificar autenticación al cargar
(async function() {
    // Primero verificar si hay una sesión activa en localStorage
    const activeTab = localStorage.getItem('cafa-session-active');
    
    // Si no hay sesión activa marcada, esta pestaña definitivamente no tiene sesión
    // Redirigir inmediatamente sin hacer petición al servidor
    if (!activeTab) {
        window.location.href = "index.html";
        return;
    }
    
    // Si hay una sesión activa, verificar con el servidor
    const isAuthenticated = await verifyAuth();
    if (!isAuthenticated) {
        // Si el servidor dice que no está autenticado, limpiar y redirigir
        clearSessionTracking();
        window.location.href = "index.html";
        return;
    }
    
    // Si llegamos aquí, la pestaña tiene sesión válida
    // verifyAuth() ya marcó la pestaña como activa si es necesario
})();

async function encryptAndSave() {
    const text = document.getElementById("plain").value.trim();
    if (!text) {
        alert("Escribe un texto");
        return;
    }

    // Cifrar en el servidor
    const encryptResult = await encryptText(text);
    if (!encryptResult.ok) {
        alert(encryptResult.msg || "Error al cifrar texto");
        return;
    }

    // Guardar texto cifrado
    const saveResult = await saveCipher(encryptResult.cipher);
    if (saveResult.ok) {
        alert("Texto guardado correctamente");
        document.getElementById("plain").value = "";
        loadList();
    } else {
        alert(saveResult.msg || "Error guardando el texto");
    }
}

async function loadList() {
    const data = await getMyTexts();
    let html = "";
    if (data.ok && data.rows) {
        if (data.rows.length === 0) {
            html = "<p>No hay textos guardados</p>";
        } else {
            data.rows.forEach(item => {
                const date = new Date(item.created_at).toLocaleString('es-ES');
                html += `<div style="margin: 10px 0; padding: 10px; background: #f1f2f6; border-radius: 8px;">
                    <p style="word-break: break-all; margin: 5px 0;">${item.cipher}</p>
                    <small style="color: #666;">${date}</small>
                </div>`;
            });
        }
    } else {
        html = "<p>Error al cargar el historial</p>";
    }
    document.getElementById("list").innerHTML = html;
}

function clearHistory() {
    if (confirm("¿Estás seguro de que quieres limpiar el historial de la vista?")) {
        document.getElementById("list").innerHTML = "";
    }
}

loadList();
</script>
</body>
</html>
