<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Desencriptar Texto</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>Desencriptar Texto</h1>

    <textarea id="ciphertext" placeholder="Texto cifrado"></textarea><br>
    <button onclick="decryptAndShow()">Desencriptar</button>

    <h2>Resultado:</h2>
    <textarea id="result" readonly></textarea>

    <p><a href="encrypt.html">Ir a Encriptar</a></p>
    <button onclick="logout()">Cerrar Sesión</button>
</div>

<script src="js/auth.js"></script>

<script>
// Verificar autenticación al cargar
(async function() {
    // Primero verificar si hay una sesión activa en localStorage
    const activeTab = localStorage.getItem('cafa-session-active');
    
    // Si no hay sesión activa marcada, esta pestaña definitivamente no tiene sesión
    // Redirigir inmediatamente sin hacer petición al servidor
    if (!activeTab) {
        window.location.href = "index.html";
        return;
    }
    
    // Si hay una sesión activa, verificar con el servidor
    const isAuthenticated = await verifyAuth();
    if (!isAuthenticated) {
        // Si el servidor dice que no está autenticado, limpiar y redirigir
        clearSessionTracking();
        window.location.href = "index.html";
        return;
    }
    
    // Si llegamos aquí, la pestaña tiene sesión válida
    // verifyAuth() ya marcó la pestaña como activa si es necesario
})();

async function decryptAndShow() {
    const cipher = document.getElementById("ciphertext").value.trim();
    if (!cipher) {
        alert("Escribe un texto cifrado");
        return;
    }

    // Descifrar en el servidor
    const result = await decryptText(cipher);
    if (result.ok) {
        document.getElementById("result").value = result.plainText;
    } else {
        document.getElementById("result").value = result.msg || "Error al descifrar";
    }
}
</script>
</body>
</html>
